# Migrations Generator Prompt
Develop a "Migrations Generator" module that integrates into the `OpenAPIHandlerGen` workflow, leveraging validated models from the `Model Generator` and the `TypesFileExtractor` to parse schema details and generate migration scripts.

## Requirements and Test Focus
### Requirements
1. **Input**:
   - Use validated models generated by the `Model Generator` as the primary input for migrations.
   - Supplement with schema changes detected by `TypesFileExtractor` for raw schema updates or manual additions.
2. **Validation**:
   - Validate that migration scripts align with the structure and definitions of the validated models.
   - Ensure compatibility with database requirements, including primary keys, foreign keys, and constraints.
   - Handle naming conflicts, reserved keywords, and unsupported types.
3. **Script Generation**:
   - Generate Swift-based migration scripts that conform to a `Migration` protocol, including:
     - **`up()`**: Defines changes to apply (e.g., creating tables, adding columns).
     - **`down()`**: Defines how to revert those changes (e.g., dropping tables).
   - Save scripts to a `Migrations/` directory with timestamped filenames for proper execution ordering.
4. **Integration**:
   - Seamlessly integrate the `Migrations Generator` into `OpenAPIHandlerGen.run()` to ensure automated migration generation during the code generation process.

### Test Suite
1. **Schema Change Extraction Tests**:
   - Validate that schema changes from the `Model Generator` and `TypesFileExtractor` are correctly identified and classified as additions or modifications.
   - Ensure focus on migration-relevant changes only.
2. **Migration Script Validation**:
   - Verify that generated migration scripts:
     - Accurately reflect the structure and constraints of validated models.
     - Correctly implement the `Migration` protocol with valid `up()` and `down()` methods.
   - Test examples for:
     - Creating new tables.
     - Adding columns to existing tables.
     - Handling invalid schema inputs or reserved keywords.
3. **Output Verification**:
   - Confirm that migration scripts are written to the correct directory (`Migrations/`) with appropriate timestamps and unique naming.
   - Ensure scripts are idempotent and ready for execution in a migration pipeline.

### Expanded Example
```swift
struct CreateUsersTable: Migration {
    func up() {
        createTable("Users") { t in
            t.column("id", .uuid).primaryKey()
            t.column("name", .string)
            t.column("email", .string).unique()
        }
    }

    func down() {
        dropTable("Users")
    }
}

struct AddAgeToUsers: Migration {
    func up() {
        addColumn("age", .int, table: "Users")
    }

    func down() {
        dropColumn("age", table: "Users")
    }
}
```

## Repository Tree
```
.github/
└── workflows/
    └── ci.yml

Docs/
├── A Pragmatic Shift Executing with Prompts.md
├── Comprehensive Test Suite for OpenAPIHandlerGen.md
├── Development and Testing Plan for OpenAPIHandlerGen.md
├── Prompts/
│   ├── Prompt 1 Setup XCTest Framework.md
│   ├── Prompt 2 CI_CD Pipeline Setup.md
│   ├── Prompt 3_ Endpoint Extraction Tests.md
│   ├── Prompt 5 Endpoint Extraction Tests.md
│   ├── Prompt 6 - Modularization Strategy for OpenAPIHandlerGen.md
│   ├── Prompt 7 - Expand Test Coverage for Schema Validation and Error Handling.md
│   └── Prompt 9 - Comprehensive Tests for Extractors.md
├── Robust CI Pipeline with Independent Build and Test Tool.md
├── Understanding the Role of Testing in Software Development.md
├── Use Case and Necessity of OpenAPIHandlerGen.md
└── Using Act to Run GitHub Actions Locally with Swift Package Manager.md

Generated/
├── Server.swift
└── Types.swift

Migrations/ **[NEW]**
├── CreateUsersTable.swift **[NEW]**
└── AddStatusToOrders.swift **[NEW]**

OpenAPIHandlerGen/
├── .gitignore
├── Package.resolved
├── Package.swift
├── Sources/
│   ├── Common/
│   │   └── ModelDefinitions.swift
│   ├── Core/
│   │   ├── OpenAPIHandlerGen.swift
│   │   └── MigrationsGenerator.swift **[NEW]**
│   ├── Extractors/
│   │   ├── OpenAPIFileEndpointExtractor.swift
│   │   ├── ServerFileExtractor.swift
│   │   ├── TypesFileExtractor.swift
│   │   └── SchemaChangeExtractor.swift **[NEW]**
│   ├── Generators/
│   │   ├── HandlerGenerator.swift
│   │   ├── ModelGenerator.swift
│   │   └── ServiceGenerator.swift
│   ├── Parsers/
│   │   └── YAMLParser.swift
│   ├── main.swift
│   └── openapi.yaml
├── TestOutput/
│   └── Handlers/
│       ├── getUsersHandler.swift
│       ├── getHandler.swift
│       └── postHandler.swift
├── Tests/
│   ├── ErrorHandlingTests.swift
│   ├── GeneratedFilesPresenceTests.swift
│   ├── HandlerGeneratorTests.swift
│   ├── InlineCodeTests.swift
│   ├── ModelGeneratorTests/
│   │   ├── ModelContentValidationTests.swift
│   │   ├── ModelDirectoryCreationTests.swift
│   │   ├── ModelErrorHandlingTests.swift
│   │   └── ModelPerformanceTests.swift
│   ├── MigrationsGeneratorTests/ **[NEW]**
│   │   ├── MigrationsContentValidationTests.swift **[NEW]**
│   │   └── MigrationsScriptGenerationTests.swift **[NEW]**
│   ├── SchemaChangeExtractorTests/ **[NEW]**
│   │   ├── SchemaChangeExtractionTests.swift **[NEW]**
│   │   └── SchemaValidationTests.swift **[NEW]**
│   ├── OpenAPIFileEndpointExtractorTests.swift
│   ├── OpenAPIPresenceTests.swift
│   ├── ServerFileExtractorTests.swift
│   ├── TemplateVerificationTests.swift
│   └── TypesFileExtractorTests.swift
└── output.swift/
    └── Handlers/
        ├── Handler.swift
        ├── getHandler.swift
        └── postHandler.swift

Scripts/
└── build_and_test.sh

TestLogs/
├── .gitkeep
├── build-<timestamp>.log (e.g., multiple log files)
├── test-results-<timestamp>.log (e.g., multiple result files)
└── test-results.log

patch_extractors.sh

LICENSE
README.md
```

